<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Конвертер валют</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    padding: 40px 20px;
    background: #f7f9fc;
    font-family: 'Inter', sans-serif;
    color: #222;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .container {
    background: #fff;
    padding: 30px 40px 40px;
    border-radius: 14px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    max-width: 400px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    font-weight: 600;
    font-size: 2.2rem;
    margin-bottom: 30px;
    color: #1a1a1a;
    user-select: none;
  }
  label {
    align-self: flex-start;
    margin-bottom: 6px;
    font-weight: 600;
    color: #444;
    user-select: none;
  }
  input, select {
    width: 100%;
    padding: 14px 16px;
    margin-bottom: 18px;
    border: 1.8px solid #cbd5e1;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 400;
    color: #1f2937;
    background: #fefefe;
    transition:
      border-color 0.3s ease,
      box-shadow 0.3s ease;
  }
  input::placeholder {
    color: #94a3b8;
  }
  input:focus, select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 8px #3b82f6aa;
    background: #fff;
  }
  input.error, select.error {
    border-color: #ef4444;
    box-shadow: 0 0 8px #ef4444aa;
    background: #ffe6e6;
  }
  .error-message {
    color: #ef4444;
    font-size: 0.85rem;
    margin-top: -14px;
    margin-bottom: 18px;
    align-self: flex-start;
    user-select: none;
    height: 18px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .error-message.visible {
    opacity: 1;
  }
  button {
    width: 100%;
    padding: 15px 0;
    border: none;
    border-radius: 12px;
    background-color: #3b82f6;
    color: #fff;
    font-weight: 600;
    font-size: 1.15rem;
    cursor: pointer;
    transition:
      background-color 0.3s ease,
      transform 0.2s ease;
    user-select: none;
  }
  button:hover {
    background-color: #2563eb;
    transform: scale(1.05);
  }
  button:active {
    transform: scale(0.98);
  }
  #result {
    margin-top: 25px;
    font-size: 1.4rem;
    font-weight: 600;
    color: #2563eb;
    min-height: 1.8em;
    text-align: center;
    user-select: none;
  }
  #history {
    margin-top: 28px;
    width: 100%;
  }
  #history h3 {
    margin-bottom: 12px;
    font-weight: 600;
    font-size: 1rem;
    color: #475569;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #history h3 button {
    background: #ef4444;
    color: white;
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #history h3 button:hover {
    background: #b91c1c;
  }
  #history ul {
    max-height: 130px;
    overflow-y: auto;
    padding-left: 18px;
    margin: 0;
    font-size: 0.95rem;
    color: #64748b;
  }
  #history li {
    margin-bottom: 7px;
    cursor: pointer;
    transition: color 0.2s ease;
  }
  #history li:hover {
    color: #3b82f6;
    text-decoration: underline;
  }
  #status {
    margin-top: 12px;
    font-size: 0.9rem;
    font-weight: 600;
    user-select: none;
    height: 22px;
    color: #333;
    text-align: center;
    transition: color 0.4s ease;
  }
  #status.loading {
    color: #2563eb;
  }
  #status.success {
    color: #22c55e;
  }
  #status.error {
    color: #ef4444;
  }
  /* ==== Manual Rate Panel ==== */
  #manualRatePanel {
    position: fixed;
    bottom: 16px;
    right: 16px;
    width: 280px;
    background: #f1f5f9;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    font-family: 'Inter', sans-serif;
    user-select: none;
    overflow: hidden;
    transition: height 0.3s ease;
    height: 40px;
    z-index: 1000;
  }
  #manualRateHeader {
    padding: 10px 18px;
    font-weight: 600;
    font-size: 1rem;
    color: #334155;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #toggleManualRate {
    background: #3b82f6;
    border: none;
    color: white;
    font-weight: 700;
    border-radius: 6px;
    width: 30px;
    height: 30px;
    cursor: pointer;
    transition: transform 0.3s ease;
    user-select: none;
  }
  #manualRateContent {
    padding: 10px 18px;
    border-top: 1px solid #cbd5e1;
    background: white;
    display: none;
  }
  #manualRefToKeyInput {
    width: 100%;
    padding: 10px 12px;
    font-size: 1rem;
    border-radius: 10px;
    border: 1.8px solid #cbd5e1;
    transition: border-color 0.3s ease;
  }
  #manualRefToKeyInput:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 8px #3b82f6aa;
    outline: none;
  }
</style>
</head>
<body>

  <div class="container">
    <h1>Конвертер валют</h1>

    <label for="amount">Сумма</label>
    <input type="number" id="amount" placeholder="Введите сумму" min="0" step="any" autocomplete="off" />

    <label for="from">Из валюты</label>
    <select id="from">
      <option value="USD">USD</option>
      <option value="KZT">KZT</option>
      <option value="KEY">KEY</option>
      <option value="REF">REF</option>
    </select>

    <label for="to">В валюту</label>
    <select id="to">
      <option value="USD">USD</option>
      <option value="KZT">KZT</option>
      <option value="KEY">KEY</option>
      <option value="REF">REF</option>
    </select>

    <button id="swapBtn" title="Поменять валюты местами">Поменять местами</button>
    <div id="status"></div>
    <div id="result">–</div>

    <div id="history">
      <h3>
        История конвертаций:
        <button id="clearHistoryBtn" title="Очистить историю">Очистить</button>
      </h3>
      <ul id="historyList"></ul>
    </div>
  </div>

  <!-- Ручной ввод курса REF → KEY -->
  <div id="manualRatePanel">
    <div id="manualRateHeader">
      REF → KEY (ручной ввод)
      <button id="toggleManualRate" aria-label="Раскрыть/Скрыть блок курса">▼</button>
    </div>
    <div id="manualRateContent">
      <input type="number" id="manualRefToKeyInput" step="any" min="0" placeholder="Введите курс REF → KEY" autocomplete="off" />
    </div>
  </div>

<script>
  // Начальные константы и переменные
  const keyToUsd = 2.4;    // фиксированный курс KEY → USD
  let keyToRef = 52.22;    // курс KEY → REF (может меняться вручную)

  const historyKey = 'converter_history';
  const settingsKey = 'converter_settings';
  const manualRateKey = 'manual_ref_to_key_rate';

  // Элементы страницы
  const amountInput = document.getElementById('amount');
  const fromSelect = document.getElementById('from');
  const toSelect = document.getElementById('to');
  const resultDiv = document.getElementById('result');
  const historyList = document.getElementById('historyList');
  const swapBtn = document.getElementById('swapBtn');
  const statusDiv = document.getElementById('status');
  const clearHistoryBtn = document.getElementById('clearHistoryBtn');

  const manualRatePanel = document.getElementById('manualRatePanel');
  const manualRateContent = document.getElementById('manualRateContent');
  const toggleBtn = document.getElementById('toggleManualRate');
  const manualInput = document.getElementById('manualRefToKeyInput');

  let history = [];
  let usdToKzt = null; // курс USD → KZT из API

  // === Логика сохранения/загрузки истории ===
  function saveHistory() {
    localStorage.setItem(historyKey, JSON.stringify(history));
  }
  function loadHistory() {
    const h = localStorage.getItem(historyKey);
    if(h) {
      try {
        history = JSON.parse(h);
      } catch {
        history = [];
      }
    }
  }
  function renderHistory() {
    historyList.innerHTML = '';
    if(history.length === 0) {
      historyList.innerHTML = '<li style="color:#94a3b8; user-select:none;">История пуста</li>';
      return;
    }
    history.forEach(entry => {
      const li = document.createElement('li');
      li.textContent = entry;
      li.title = 'Кликните, чтобы подставить в форму';
      li.addEventListener('click', () => {
        // Разбор записи вида "100 USD → KZT = 456.78 (HH:MM:SS)"
        const parts = entry.split(' ');
        if(parts.length < 7) return;
        amountInput.value = parts[0];
        fromSelect.value = parts[1];
        toSelect.value = parts[3];
        calculateAndShow();
      });
      historyList.appendChild(li);
    });
  }

  clearHistoryBtn.addEventListener('click', () => {
    history = [];
    saveHistory();
    renderHistory();
  });

  // === Сохранение и загрузка настроек (сумма, валюты) ===
  function saveSettings() {
    const settings = {
      amount: amountInput.value,
      from: fromSelect.value,
      to: toSelect.value
    };
    localStorage.setItem(settingsKey, JSON.stringify(settings));
  }
  function loadSettings() {
    const s = localStorage.getItem(settingsKey);
    if(s) {
      try {
        const settings = JSON.parse(s);
        if(settings.amount) amountInput.value = settings.amount;
        if(settings.from) fromSelect.value = settings.from;
        if(settings.to) toSelect.value = settings.to;
      } catch {}
    }
  }

  // === Сохранение и загрузка ручного курса REF→KEY ===
  function saveManualRate() {
    const val = parseFloat(manualInput.value);
    if(!isNaN(val) && val > 0) {
      keyToRef = val;
      localStorage.setItem(manualRateKey, val.toString());
    }
  }
  function loadManualRate() {
    const val = localStorage.getItem(manualRateKey);
    if(val && !isNaN(parseFloat(val))) {
      keyToRef = parseFloat(val);
      manualInput.value = keyToRef;
    } else {
      manualInput.value = keyToRef;
    }
  }

  // === API получение курса USD → KZT с floatres.com ===
  async function fetchUsdToKzt() {
    statusDiv.textContent = 'Загрузка курса USD → KZT...';
    statusDiv.className = 'loading';

    try {
      // floatres API пример: https://floatres.com/api/v1/rate?base=USD&target=KZT
      const res = await fetch('https://floatres.com/api/v1/rate?base=USD&target=KZT');
      if(!res.ok) throw new Error('Ошибка сети');
      const data = await res.json();

      // Ожидаем структура: { "base":"USD", "target":"KZT", "rate": <число> }
      if(data && typeof data.rate === 'number' && data.rate > 0) {
        usdToKzt = data.rate;
        statusDiv.textContent = 'Курс USD → KZT обновлен';
        statusDiv.className = 'success';
        return;
      }
      throw new Error('Неверный формат данных');
    } catch (e) {
      usdToKzt = null;
      statusDiv.textContent = 'Не удалось получить курс USD → KZT';
      statusDiv.className = 'error';
    }
  }

  // === Валидация ===
  function validate() {
    let valid = true;

    if(amountInput.value === '' || isNaN(amountInput.value) || Number(amountInput.value) <= 0) {
      amountInput.classList.add('error');
      valid = false;
    } else {
      amountInput.classList.remove('error');
    }

    if(!fromSelect.value || !['USD','KZT','KEY','REF'].includes(fromSelect.value)) {
      fromSelect.classList.add('error');
      valid = false;
    } else {
      fromSelect.classList.remove('error');
    }

    if(!toSelect.value || !['USD','KZT','KEY','REF'].includes(toSelect.value)) {
      toSelect.classList.add('error');
      valid = false;
    } else {
      toSelect.classList.remove('error');
    }

    if(fromSelect.value === toSelect.value) {
      valid = false;
      statusDiv.textContent = 'Нельзя конвертировать валюту в саму себя';
      statusDiv.className = 'error';
    } else {
      if(statusDiv.className === 'error') {
        statusDiv.textContent = '';
        statusDiv.className = '';
      }
    }

    return valid;
  }

  // === Конвертация валют ===
  function convert(amount, from, to) {
    // Переводим всё сначала в KEY (основная внутренняя валюта)
    let amountInKey;
    switch(from) {
      case 'KEY':
        amountInKey = amount;
        break;
      case 'USD':
        amountInKey = amount / keyToUsd;
        break;
      case 'REF':
        amountInKey = amount / keyToRef;
        break;
      case 'KZT':
        if(usdToKzt) {
          amountInKey = amount / (keyToUsd * usdToKzt);
        } else {
          throw new Error('Курс KZT неизвестен');
        }
        break;
      default:
        throw new Error('Неизвестная валюта отправления');
    }

    // Теперь из KEY в целевую валюту
    switch(to) {
      case 'KEY':
        return amountInKey;
      case 'USD':
        return amountInKey * keyToUsd;
      case 'REF':
        return amountInKey * keyToRef;
      case 'KZT':
        if(usdToKzt) {
          return amountInKey * keyToUsd * usdToKzt;
        } else {
          throw new Error('Курс KZT неизвестен');
        }
      default:
        throw new Error('Неизвестная валюта назначения');
    }
  }

  // === Основная функция расчёта и отображения результата ===
  function calculateAndShow() {
    if(!validate()) {
      resultDiv.textContent = '–';
      return;
    }
    const amount = parseFloat(amountInput.value);
    const from = fromSelect.value;
    const to = toSelect.value;

    try {
      const converted = convert(amount, from, to);
      const rounded = Math.round(converted * 100) / 100;
      resultDiv.textContent = `${rounded} ${to}`;

      // Добавить в историю с временем
      const now = new Date();
      const hh = now.getHours().toString().padStart(2, '0');
      const mm = now.getMinutes().toString().padStart(2, '0');
      const ss = now.getSeconds().toString().padStart(2, '0');
      const timeStr = `${hh}:${mm}:${ss}`;

      const entry = `${amount} ${from} → ${to} = ${rounded} (${timeStr})`;
      if(history[0] !== entry) {
        history.unshift(entry);
        if(history.length > 15) history.pop();
        saveHistory();
        renderHistory();
      }
      statusDiv.textContent = '';
      statusDiv.className = '';
    } catch(err) {
      resultDiv.textContent = 'Ошибка';
      statusDiv.textContent = err.message;
      statusDiv.className = 'error';
    }
  }

  // === События ===

  // Поменять валюты местами
  swapBtn.addEventListener('click', () => {
    const fromVal = fromSelect.value;
    const toVal = toSelect.value;
    fromSelect.value = toVal;
    toSelect.value = fromVal;
    saveSettings();
    calculateAndShow();
  });

  // Автоматический пересчёт при вводе и изменении валют
  [amountInput, fromSelect, toSelect].forEach(elem => {
    elem.addEventListener('input', () => {
      saveSettings();
      calculateAndShow();
    });
  });

  // Смена вручную курса REF→KEY
  manualInput.addEventListener('input', () => {
    saveManualRate();
    calculateAndShow();
  });

  // Раскрытие/сворачивание блока ручного ввода курса
  let manualOpen = false;
  toggleBtn.addEventListener('click', () => {
    manualOpen = !manualOpen;
    if(manualOpen) {
      manualRateContent.style.display = 'block';
      manualRatePanel.style.height = '130px';
      toggleBtn.textContent = '▲';
    } else {
      manualRateContent.style.display = 'none';
      manualRatePanel.style.height = '40px';
      toggleBtn.textContent = '▼';
    }
  });

  // Инициализация
  loadManualRate();
  loadHistory();
  loadSettings();
  renderHistory();
  calculateAndShow();
  fetchUsdToKzt();

  // Автообновление курса USD→KZT каждые 15 минут
  setInterval(fetchUsdToKzt, 900000);

</script>

</body>
</html>
