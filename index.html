<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Конвертер валют с backpack.tf API</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f7fa;
    color: #333;
    max-width: 480px;
    margin: 30px auto;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
  h1 {
    text-align: center;
  }
  label {
    display: block;
    margin-top: 15px;
  }
  input, select {
    width: 100%;
    padding: 8px 12px;
    margin-top: 5px;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
  }
  button {
    margin-top: 20px;
    width: 100%;
    background: #0077cc;
    border: none;
    color: white;
    font-size: 1.1rem;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #005fa3;
  }
  #history {
    margin-top: 25px;
    max-height: 150px;
    overflow-y: auto;
    border-top: 1px solid #ccc;
    padding-top: 15px;
  }
  #history li {
    cursor: pointer;
    padding: 5px 8px;
    border-radius: 5px;
  }
  #history li:hover {
    background: #d0e7ff;
  }
  .error {
    border-color: #cc0000 !important;
  }
</style>
</head>
<body>
<h1>Конвертер валют</h1>

<label for="amountFrom">Сумма (из):</label>
<input type="number" id="amountFrom" min="0" step="any" />

<label for="currencyFrom">Валюта (из):</label>
<select id="currencyFrom">
  <option value="usd">USD</option>
  <option value="kzt">KZT</option>
  <option value="key">KEY</option>
  <option value="ref">REF</option>
</select>

<label for="amountTo">Сумма (в):</label>
<input type="number" id="amountTo" min="0" step="any" />

<label for="currencyTo">Валюта (в):</label>
<select id="currencyTo">
  <option value="usd">USD</option>
  <option value="kzt">KZT</option>
  <option value="key">KEY</option>
  <option value="ref">REF</option>
</select>

<button id="swapBtn">Поменять местами валюты и суммы</button>

<ul id="history"></ul>

<script>
  const backpackApiKey = '68a1d6d01326fe092a02c00c';

  const amountFrom = document.getElementById('amountFrom');
  const currencyFrom = document.getElementById('currencyFrom');
  const amountTo = document.getElementById('amountTo');
  const currencyTo = document.getElementById('currencyTo');
  const swapBtn = document.getElementById('swapBtn');
  const historyList = document.getElementById('history');

  let rates = {
    usd: 1,
    kzt: 1,
  };

  // Фиксируем курс Refined Metal к USD (пример)
  let refToUsd = 0.20;

  // Цены в металле (Refined Metal) — обновим с backpack.tf API
  let keyPriceMetal = 52.22; // стартовое значение
  let refPriceMetal = 1;     // всегда 1 Refined Metal

  let isUpdating = false;
  let history = JSON.parse(localStorage.getItem('history') || '[]');

  async function loadFloatRates() {
    try {
      const res = await fetch('https://www.floatrates.com/daily/usd.json');
      const data = await res.json();
      if(data.kzt && data.kzt.rate) {
        rates.kzt = data.kzt.rate;
      }
      rates.usd = 1;
    } catch(e) {
      console.error('Ошибка загрузки курсов floatrates', e);
    }
  }

  async function loadBackpackTfPrices() {
    if (!backpackApiKey) {
      console.log('backpack.tf API ключ не указан, используются статичные значения');
      return;
    }
    try {
      const url = `https://backpack.tf/api/IGetMarketPrices/v1?key=${backpackApiKey}`;
      const res = await fetch(url);
      const data = await res.json();

      if (!data.response || !data.response.items) {
        console.warn('backpack.tf API вернул неправильный ответ', data);
        return;
      }

      const items = data.response.items;

      const keyItem = items['Mann Co. Supply Crate Key'];
      const refItem = items['Refined Metal'];

      if (!keyItem || !refItem) {
        console.warn('Не найдены цены key или ref в backpack.tf');
        return;
      }

      keyPriceMetal = keyItem.value.value; // в Refined Metal
      refPriceMetal = refItem.value.value; // обычно 1

      console.log(`Цены с backpack.tf: KEY=${keyPriceMetal} ref, REF=${refPriceMetal} ref`);
    } catch(e) {
      console.error('Ошибка при запросе backpack.tf API', e);
    }
  }

  function convertCurrency(amount, from, to) {
    if (isNaN(amount) || amount <= 0) return 0;

    let amountInUsd;

    switch(from) {
      case 'usd':
        amountInUsd = amount;
        break;
      case 'kzt':
        amountInUsd = amount / rates.kzt;
        break;
      case 'key':
        amountInUsd = amount * keyPriceMetal * refToUsd;
        break;
      case 'ref':
        amountInUsd = amount * refToUsd;
        break;
      default:
        amountInUsd = amount;
    }

    let result;

    switch(to) {
      case 'usd':
        result = amountInUsd;
        break;
      case 'kzt':
        result = amountInUsd * rates.kzt;
        break;
      case 'key':
        result = amountInUsd / (keyPriceMetal * refToUsd);
        break;
      case 'ref':
        result = amountInUsd / refToUsd;
        break;
      default:
        result = amountInUsd;
    }

    return result;
  }

  function saveHistory(fromAmount, from, toAmount, to) {
    const record = `${fromAmount.toFixed(4)} ${from.toUpperCase()} → ${toAmount.toFixed(4)} ${to.toUpperCase()}`;
    history.unshift(record);
    if (history.length > 10) history.pop();
    localStorage.setItem('history', JSON.stringify(history));
    renderHistory();
  }

  function renderHistory() {
    historyList.innerHTML = '';
    history.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      li.addEventListener('click', () => {
        // При клике вставляем запись в поля
        const parts = item.split(' ');
        if(parts.length >= 4) {
          amountFrom.value = parseFloat(parts[0]);
          currencyFrom.value = parts[1].toLowerCase();
          amountTo.value = parseFloat(parts[3]);
          currencyTo.value = parts[4].toLowerCase();
        }
      });
      historyList.appendChild(li);
    });
  }

  function convert(direction) {
    const from = currencyFrom.value;
    const to = currencyTo.value;

    let fromAmountVal = parseFloat(amountFrom.value);
    let toAmountVal = parseFloat(amountTo.value);

    if (direction === 'forward') {
      if (isNaN(fromAmountVal) || fromAmountVal <= 0) {
        amountFrom.classList.add('error');
        return;
      } else {
        amountFrom.classList.remove('error');
      }
      const converted = convertCurrency(fromAmountVal, from, to);
      amountTo.value = converted.toFixed(4);
      saveHistory(fromAmountVal, from, converted, to);
    } else if (direction === 'backward') {
      if (isNaN(toAmountVal) || toAmountVal <= 0) {
        amountTo.classList.add('error');
        return;
      } else {
        amountTo.classList.remove('error');
      }
      const converted = convertCurrency(toAmountVal, to, from);
      amountFrom.value = converted.toFixed(4);
      saveHistory(converted, from, toAmountVal, to);
    }
  }

  amountFrom.addEventListener('input', () => convert('forward'));
  currencyFrom.addEventListener('change', () => convert('forward'));
  amountTo.addEventListener('input', () => convert('backward'));
  currencyTo.addEventListener('change', () => convert('forward'));

  swapBtn.addEventListener('click', () => {
    // Поменять валюты
    const tempCurrency = currencyFrom.value;
    currencyFrom.value = currencyTo.value;
    currencyTo.value = tempCurrency;

    // Поменять суммы
    const tempAmount = amountFrom.value;
    amountFrom.value = amountTo.value;
    amountTo.value = tempAmount;

    convert('forward');
  });

  async function updateAllRates() {
    if (isUpdating) return;
    isUpdating = true;
    await loadFloatRates();
    await loadBackpackTfPrices();
    convert('forward');
    isUpdating = false;
  }

  function init() {
    renderHistory();
    updateAllRates();
    // Обновлять курсы каждые 10 минут
    setInterval(updateAllRates, 10 * 60 * 1000);
  }

  init();

</script>
</body>
</html>
