<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Конвертер валют с backpack.tf API</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f7fa;
    color: #333;
    max-width: 480px;
    margin: 30px auto;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
  h1 {
    text-align: center;
  }
  label {
    display: block;
    margin-top: 15px;
  }
  input, select {
    width: 100%;
    padding: 8px 12px;
    margin-top: 5px;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
  }
  button {
    margin-top: 20px;
    width: 100%;
    background: #0077cc;
    border: none;
    color: white;
    font-size: 1.1rem;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #005fa3;
  }
  #history {
    margin-top: 25px;
    max-height: 150px;
    overflow-y: auto;
    border-top: 1px solid #ccc;
    padding-top: 15px;
  }
  #history li {
    cursor: pointer;
    padding: 5px 8px;
    border-radius: 5px;
  }
  #history li:hover {
    background: #d0e7ff;
  }
  .error {
    border-color: #cc0000 !important;
  }
</style>
</head>
<body>
<h1>Конвертер валют</h1>

<label for="amountFrom">Сумма (из):</label>
<input type="number" id="amountFrom" min="0" step="any" />

<label for="currencyFrom">Валюта (из):</label>
<select id="currencyFrom">
  <option value="usd">USD</option>
  <option value="kzt">KZT</option>
  <option value="key">KEY</option>
  <option value="ref">REF</option>
</select>

<label for="amountTo">Сумма (в):</label>
<input type="number" id="amountTo" min="0" step="any" />

<label for="currencyTo">Валюта (в):</label>
<select id="currencyTo">
  <option value="usd">USD</option>
  <option value="kzt">KZT</option>
  <option value="key">KEY</option>
  <option value="ref">REF</option>
</select>

<button id="swapBtn">Поменять местами валюты и суммы</button>

<ul id="history"></ul>

<script>
  // Ключ API backpack.tf
  const backpackApiKey = '68a1d6d01326fe092a02c00c';

  // Элементы
  const amountFrom = document.getElementById('amountFrom');
  const currencyFrom = document.getElementById('currencyFrom');
  const amountTo = document.getElementById('amountTo');
  const currencyTo = document.getElementById('currencyTo');
  const swapBtn = document.getElementById('swapBtn');
  const historyList = document.getElementById('history');

  // Курсы валют (usd и kzt обновятся через API, key и ref — свои формулы)
  let rates = {
    usd: 1,
    kzt: 1,
  };

  // Статические курсы, будут обновляться по backpack.tf API
  let keyToUsd = 2.40; // KEY к USD (фикс)
  let keyToRef = 52.22; // REF к KEY (будет обновляться)
  
  // Для предотвращения повторных обновлений
  let updating = false;

  // История конвертаций
  let history = JSON.parse(localStorage.getItem('history') || '[]');

  // Загружаем курсы usd и kzt с FloatRates API
  async function loadFloatRates() {
    try {
      const res = await fetch('https://www.floatrates.com/daily/usd.json');
      const data = await res.json();
      if(data.kzt && data.kzt.rate) {
        rates.kzt = data.kzt.rate;
      } else {
        console.warn('Не получили курс KZT');
      }
      // usd всегда 1
      rates.usd = 1;
    } catch(e) {
      console.error('Ошибка загрузки курсов floatrates', e);
    }
  }

  // Получить курс REF к KEY с backpack.tf API
  async function loadBackpackTfRefRate() {
    if (!backpackApiKey) {
      console.log('backpack.tf API ключ не указан, используем статический курс REF');
      return keyToRef;
    }

    try {
      const url = `https://backpack.tf/api/IGetMarketPrices/v1?key=${backpackApiKey}`;
      const res = await fetch(url);
      const data = await res.json();

      if (!data.response || !data.response.items) {
        console.warn('backpack.tf API вернул неправильный ответ', data);
        return keyToRef;
      }

      const items = data.response.items;

      const keyPrice = items['Mann Co. Supply Crate Key']?.value?.value || null;
      const refPrice = items['Refined Metal']?.value?.value || null;

      if (!keyPrice || !refPrice) {
        console.warn('Не найдены цены key или ref в backpack.tf');
        return keyToRef;
      }

      // keyPrice и refPrice примерно в одних единицах (metal units), keyPrice ~ 50 ref
      const refPerKey = keyPrice / refPrice;

      console.log(`Курс KEY к REF от backpack.tf: ${refPerKey}`);

      return refPerKey;

    } catch(e) {
      console.error('Ошибка при запросе backpack.tf API', e);
      return keyToRef;
    }
  }

  // Обновление курса keyToRef динамически
  async function updateRefRate() {
    const newRefRate = await loadBackpackTfRefRate();
    if (newRefRate && !isNaN(newRefRate) && newRefRate > 0) {
      keyToRef = newRefRate;
    }
    console.log('Текущий курс KEY к REF:', keyToRef);
  }

  // Функция конвертации
  function convert(direction) {
    const from = currencyFrom.value;
    const to = currencyTo.value;

    let fromAmount = parseFloat(amountFrom.value);
    let toAmount = parseFloat(amountTo.value);

    if (direction === 'forward') {
      if (isNaN(fromAmount) || fromAmount <= 0) {
        amountFrom.classList.add('error');
        return;
      } else {
        amountFrom.classList.remove('error');
      }
      toAmount = convertCurrency(fromAmount, from, to);
      amountTo.value = toAmount.toFixed(4);
    } else if (direction === 'backward') {
      if (isNaN(toAmount) || toAmount <= 0) {
        amountTo.classList.add('error');
        return;
      } else {
        amountTo.classList.remove('error');
      }
      fromAmount = convertCurrency(toAmount, to, from);
      amountFrom.value = fromAmount.toFixed(4);
    }

    saveHistory(fromAmount, from, toAmount, to);
    renderHistory();
  }

  // Функция конвертации между валютами с учетом курсов и формул
  function convertCurrency(amount, from, to) {
    // Приводим все к USD
    let amountInUsd;

    switch(from) {
      case 'usd':
        amountInUsd = amount;
        break;
      case 'kzt':
        amountInUsd = amount / rates.kzt;
        break;
      case 'key':
        amountInUsd = amount * keyToUsd;
        break;
      case 'ref':
        // REF -> KEY -> USD
        amountInUsd = (amount / keyToRef) * keyToUsd;
        break;
      default:
        amountInUsd = amount;
    }

    // USD -> to
    let result;

    switch(to) {
      case 'usd':
        result = amountInUsd;
        break;
      case 'kzt':
        result = amountInUsd * rates.kzt;
        break;
      case 'key':
        result = amountInUsd / keyToUsd;
        break;
      case 'ref':
        // USD -> KEY -> REF
        result = (amountInUsd / keyToUsd) * keyToRef;
        break;
      default:
        result = amountInUsd;
    }

    return result;
  }

  // Сохраняем в историю
  function saveHistory(fromAmount, from, toAmount, to) {
    const record = `${fromAmount.toFixed(4)} ${from} = ${toAmount.toFixed(4)} ${to}`;
    history.unshift(record);
    if (history.length > 10) history.pop();
    localStorage.setItem('history', JSON.stringify(history));
  }

  // Отрисовка истории
  function renderHistory() {
    historyList.innerHTML = '';
    history.forEach((item, i) => {
      const li = document.createElement('li');
      li.textContent = item;
      li.dataset.index = i;
      historyList.appendChild(li);
    });
  }

  // Восстановление настроек из localStorage
  function restoreSettings() {
    if (history.length > 0) {
      const last = history[0].split(' ');
      if (last.length >= 4) {
        amountFrom.value = last[0];
        currencyFrom.value = last[1];
        amountTo.value = last[3];
        currencyTo.value = last[4];
      }
    }
  }

  // Дебаунс
  function debounce(func, delay) {
    let timer;
    return function(...args) {
      clearTimeout(timer);
      timer = setTimeout(() => func.apply(this, args), delay);
    };
  }

  // Обработчики
  amountFrom.addEventListener('input', debounce(() => convert('forward'), 300));
  currencyFrom.addEventListener('change', () => convert('forward'));
  amountTo.addEventListener('input', debounce(() => convert('backward'), 300));
  currencyTo.addEventListener('change', () => convert('forward'));

  swapBtn.addEventListener('click', () => {
    const tmpCur = currencyFrom.value;
    currencyFrom.value = currencyTo.value;
    currencyTo.value = tmpCur;

    const tmpAmt = amountFrom.value;
    amountFrom.value = amountTo.value;
    amountTo.value = tmpAmt;

    convert('forward');
  });

  historyList.addEventListener('click', e => {
    if(e.target.tagName !== 'LI') return;
    const idx = +e.target.dataset.index;
    if(idx >= 0 && idx < history.length) {
      const parts = history[idx].split(' ');
      if(parts.length >= 4) {
        amountFrom.value = parts[0];
        currencyFrom.value = parts[1];
        amountTo.value = parts[3];
        currencyTo.value = parts[4];
        convert('forward');
      }
    }
  });

  // Инициализация
  async function init() {
    await loadFloatRates();
    await updateRefRate();
    restoreSettings();
    if(amountFrom.value) {
      convert('forward');
    } else if(amountTo.value) {
      convert('backward');
    }
    renderHistory();

    // Обновление каждые 10 минут
    setInterval(async () => {
      if(!updating) {
        updating = true;
        await loadFloatRates();
        await updateRefRate();
        updating = false;
        if(amountFrom.value) convert('forward');
      }
    }, 600000);
  }

  init();

</script>
</body>
</html>
