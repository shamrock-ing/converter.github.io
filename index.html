<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Конвертер валют</title>
  <style>
    /* Стили прежние, как договаривались */
    /* ... */
  </style>
</head>
<body>
  <div class="container">
    <!-- Поля ввода, история, кнопки — остаются без изменений -->
    <!-- ... -->
  </div>

  <!-- Ручной ввод REF→KEY -->
  <div id="manualRatePanel">
    <!-- ... -->
  </div>

  <script>
    const keyToUsd = 2.4;
    let keyToRef = 52.22;

    const historyKey = 'converter_history';
    const settingsKey = 'converter_settings';
    const manualRateKey = 'manual_ref_to_key_rate';

    const amountInput = document.getElementById('amount');
    const fromSelect = document.getElementById('from');
    const toSelect = document.getElementById('to');
    const resultDiv = document.getElementById('result');
    const historyList = document.getElementById('historyList');
    const swapBtn = document.getElementById('swapBtn');
    const statusDiv = document.getElementById('status');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');

    const manualRatePanel = document.getElementById('manualRatePanel');
    const manualRateContent = document.getElementById('manualRateContent');
    const toggleBtn = document.getElementById('toggleManualRate');
    const manualInput = document.getElementById('manualRefToKeyInput');

    let history = [];
    let usdToKzt = null;

    // Загрузка ручного курса
    const savedManual = localStorage.getItem(manualRateKey);
    if (savedManual && !isNaN(parseFloat(savedManual))) {
      keyToRef = parseFloat(savedManual);
      manualInput.value = keyToRef;
    }

    function saveManualRate() {
      const v = parseFloat(manualInput.value);
      if (!isNaN(v) && v > 0) {
        keyToRef = v;
        localStorage.setItem(manualRateKey, v.toString());
      }
    }

    async function fetchUsdToKzt() {
      statusDiv.textContent = 'Загрузка курса USD → KZT...';
      statusDiv.className = 'loading';
      try {
        const res = await fetch('https://www.floatrates.com/daily/usd.json');
        if (!res.ok) throw new Error('Сеть недоступна');
        const data = await res.json();

        console.log('Ключи API:', Object.keys(data));
        if (!data['kzt'] || !data['kzt'].rate) {
          throw new Error('Курс KZT не найден');
        }

        usdToKzt = data['kzt'].rate;
        statusDiv.textContent = 'Курс USD → KZT загружен';
        statusDiv.className = 'success';
      } catch (e) {
        usdToKzt = null;
        statusDiv.textContent = 'Ошибка загрузки курса USD → KZT';
        statusDiv.className = 'error';
        console.error('Ошибка:', e);
      }
    }

    function validate() {
      // простая валидация...
      return true;
    }

    function convert(amount, from, to) {
      if (from === to) return amount;
      let inKey;
      switch (from) {
        case 'KEY': inKey = amount; break;
        case 'USD': inKey = amount / keyToUsd; break;
        case 'REF': inKey = amount / keyToRef; break;
        case 'KZT':
          if (!usdToKzt) throw new Error('Курс KZT недоступен');
          inKey = amount / (keyToUsd * usdToKzt);
          break;
        default: throw new Error('Неизвестная валюта');
      }
      switch (to) {
        case 'KEY': return inKey;
        case 'USD': return inKey * keyToUsd;
        case 'REF': return inKey * keyToRef;
        case 'KZT':
          if (!usdToKzt) throw new Error('Курс KZT недоступен');
          return inKey * keyToUsd * usdToKzt;
        default: throw new Error('Неизвестная валюта');
      }
    }

    function calculateAndShow() {
      if (!validate()) { resultDiv.textContent = '–'; return; }
      const amount = parseFloat(amountInput.value);
      const from = fromSelect.value;
      const to = toSelect.value;
      try {
        const out = convert(amount, from, to);
        resultDiv.textContent = `${(Math.round(out * 100) / 100)} ${to}`;

        const now = new Date();
        const t = now.toTimeString().split(' ')[0];
        const entry = `${amount} ${from} → ${to} = ${(Math.round(out * 100) / 100)} (${t})`;

        history.unshift(entry);
        if (history.length > 15) history.pop();
        localStorage.setItem(historyKey, JSON.stringify(history));
        renderHistory();
      } catch(e) {
        resultDiv.textContent = 'Ошибка';
        statusDiv.textContent = e.message;
        statusDiv.className = 'error';
      }
    }

    function renderHistory() {
      historyList.innerHTML = '';
      if (!history.length) {
        historyList.innerHTML = '<li style="color:#999;">История пуста</li>';
        return;
      }
      history.forEach(h => {
        const li = document.createElement('li');
        li.textContent = h;
        historyList.appendChild(li);
      });
    }

    swapBtn.addEventListener('click', () => {
      const a = fromSelect.value;
      fromSelect.value = toSelect.value;
      toSelect.value = a;
      calculateAndShow();
    });

    [amountInput, fromSelect, toSelect].forEach(el =>
      el.addEventListener('input', calculateAndShow)
    );

    manualInput.addEventListener('input', () => {
      saveManualRate();
      calculateAndShow();
    });

    toggleBtn.addEventListener('click', () => {
      if (manualRateContent.style.display === 'block') {
        manualRateContent.style.display = 'none';
        manualRatePanel.style.height = '40px';
        toggleBtn.textContent = '▼';
      } else {
        manualRateContent.style.display = 'block';
        manualRatePanel.style.height = '110px';
        toggleBtn.textContent = '▲';
      }
    });

    (function init() {
      const hs = localStorage.getItem(historyKey);
      if (hs) history = JSON.parse(hs) || [];
      loadSettings();
      renderHistory();
      calculateAndShow();
      fetchUsdToKzt();
      setInterval(fetchUsdToKzt, 900000); // обновление каждые 15 мин
    })();

    function loadSettings() {
      const s = localStorage.getItem(settingsKey);
      if (s) {
        try {
          const ss = JSON.parse(s);
          if (ss.amount) amountInput.value = ss.amount;
          if (ss.from) fromSelect.value = ss.from;
          if (ss.to) toSelect.value = ss.to;
        } catch {}
      }
    }
  </script>
</body>
</html>
