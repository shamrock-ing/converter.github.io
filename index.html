<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Конвертер валют</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    padding: 40px 20px;
    background: #f7f9fc;
    font-family: 'Inter', sans-serif;
    color: #222;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .container {
    background: #fff;
    padding: 30px 40px 40px;
    border-radius: 14px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    max-width: 400px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    font-weight: 600;
    font-size: 2.2rem;
    margin-bottom: 30px;
    color: #1a1a1a;
    user-select: none;
  }
  label {
    align-self: flex-start;
    margin-bottom: 6px;
    font-weight: 600;
    color: #444;
    user-select: none;
  }
  input, select {
    width: 100%;
    padding: 14px 16px;
    margin-bottom: 18px;
    border: 1.8px solid #cbd5e1;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 400;
    color: #1f2937;
    background: #fefefe;
    transition:
      border-color 0.3s ease,
      box-shadow 0.3s ease;
  }
  input::placeholder {
    color: #94a3b8;
  }
  input:focus, select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 8px #3b82f6aa;
    background: #fff;
  }
  input.error, select.error {
    border-color: #ef4444;
    box-shadow: 0 0 8px #ef4444aa;
    background: #ffe6e6;
  }
  .error-message {
    color: #ef4444;
    font-size: 0.85rem;
    margin-top: -14px;
    margin-bottom: 18px;
    align-self: flex-start;
    user-select: none;
    height: 18px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .error-message.visible {
    opacity: 1;
  }
  button {
    width: 100%;
    padding: 15px 0;
    border: none;
    border-radius: 12px;
    background-color: #3b82f6;
    color: #fff;
    font-weight: 600;
    font-size: 1.15rem;
    cursor: pointer;
    transition:
      background-color 0.3s ease,
      transform 0.2s ease;
    user-select: none;
  }
  button:hover {
    background-color: #2563eb;
    transform: scale(1.05);
  }
  button:active {
    transform: scale(0.98);
  }
  #result {
    margin-top: 25px;
    font-size: 1.4rem;
    font-weight: 600;
    color: #2563eb;
    min-height: 1.8em;
    text-align: center;
    user-select: none;
  }
  #history {
    margin-top: 28px;
    width: 100%;
  }
  #history h3 {
    margin-bottom: 12px;
    font-weight: 600;
    font-size: 1rem;
    color: #475569;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #history h3 button {
    background: #ef4444;
    color: white;
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #history h3 button:hover {
    background: #b91c1c;
  }
  #history ul {
    max-height: 130px;
    overflow-y: auto;
    padding-left: 18px;
    margin: 0;
    font-size: 0.95rem;
    color: #64748b;
  }
  #history li {
    margin-bottom: 7px;
    cursor: pointer;
    transition: color 0.2s ease;
  }
  #history li:hover {
    color: #3b82f6;
    text-decoration: underline;
  }
  #status {
    margin-top: 12px;
    font-size: 0.9rem;
    font-weight: 600;
    user-select: none;
    height: 22px;
    color: #333;
    text-align: center;
    transition: color 0.4s ease;
  }
  #status.loading {
    color: #2563eb;
  }
  #status.success {
    color: #22c55e;
  }
  #status.error {
    color: #ef4444;
  }
  /* ==== Manual Rate Panel ==== */
  #manualRatePanel {
    position: fixed;
    bottom: 16px;
    right: 16px;
    width: 280px;
    background: #f1f5f9;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    font-family: 'Inter', sans-serif;
    user-select: none;
    overflow: hidden;
    transition: height 0.3s ease;
    height: 40px;
    z-index: 1000;
  }
  #manualRateHeader {
    padding: 10px 18px;
    font-weight: 600;
    font-size: 1rem;
    color: #334155;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #toggleManualRate {
    background: #3b82f6;
    border: none;
    color: white;
    font-weight: 700;
    border-radius: 6px;
    width: 30px;
    height: 30px;
    cursor: pointer;
    transition: transform 0.3s ease;
    user-select: none;
  }
  #manualRateContent {
    padding: 10px 18px;
    border-top: 1px solid #cbd5e1;
    background: white;
    display: none;
  }
  #manualRefToKeyInput {
    width: 100%;
    padding: 10px 12px;
    font-size: 1rem;
    border-radius: 10px;
    border: 1.8px solid #cbd5e1;
    transition: border-color 0.3s ease;
  }
  #manualRefToKeyInput:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 8px #3b82f6aa;
    outline: none;
  }
</style>
</head>
<body>

  <div class="container">
    <h1>Конвертер валют</h1>

    <label for="amount">Сумма</label>
    <input type="number" id="amount" placeholder="Введите сумму" min="0" step="any" autocomplete="off" />

    <label for="from">Из валюты</label>
    <select id="from">
      <option value="USD">USD</option>
      <option value="KZT">KZT</option>
      <option value="KEY">KEY</option>
      <option value="REF">REF</option>
    </select>

    <label for="to">В валюту</label>
    <select id="to">
      <option value="USD">USD</option>
      <option value="KZT">KZT</option>
      <option value="KEY">KEY</option>
      <option value="REF">REF</option>
    </select>

    <button id="convertBtn">Конвертировать</button>
    <div id="status"></div>
    <div id="result">–</div>

    <div id="history">
      <h3>
        История конвертаций:
        <button id="clearHistoryBtn" title="Очистить историю">Очистить</button>
      </h3>
      <ul id="historyList"></ul>
    </div>
  </div>

  <!-- Ручной ввод курса REF → KEY -->
  <div id="manualRatePanel">
    <div id="manualRateHeader">
      REF → KEY (ручной ввод)
      <button id="toggleManualRate" aria-label="Раскрыть/Скрыть блок курса">▼</button>
    </div>
    <div id="manualRateContent">
      <input type="number" id="manualRefToKeyInput" step="any" min="0" placeholder="Введите курс REF → KEY" autocomplete="off" />
    </div>
  </div>

<script>
  // Начальные константы и переменные
  const keyToUsd = 2.4;    // фиксированный курс KEY → USD
  let keyToRef = 52.22;    // курс KEY → REF (может меняться вручную)

  const historyKey = 'converter_history';
  const settingsKey = 'converter_settings';
  const manualRateKey = 'manual_ref_to_key_rate';

  // Элементы страницы
  const amountInput = document.getElementById('amount');
  const fromSelect = document.getElementById('from');
  const toSelect = document.getElementById('to');
  const resultDiv = document.getElementById('result');
  const historyList = document.getElementById('historyList');
  const convertBtn = document.getElementById('convertBtn');
  const statusDiv = document.getElementById('status');
  const clearHistoryBtn = document.getElementById('clearHistoryBtn');

  const manualRatePanel = document.getElementById('manualRatePanel');
  const manualRateContent = document.getElementById('manualRateContent');
  const toggleBtn = document.getElementById('toggleManualRate');
  const manualInput = document.getElementById('manualRefToKeyInput');

  // История и настройки
  let history = JSON.parse(localStorage.getItem(historyKey)) || [];
  let settings = JSON.parse(localStorage.getItem(settingsKey)) || {};

  // Инициализация значения manualRefToKey из localStorage
  const savedManualRate = localStorage.getItem(manualRateKey);
  if (savedManualRate !== null && !isNaN(parseFloat(savedManualRate))) {
    keyToRef = parseFloat(savedManualRate);
    manualInput.value = keyToRef;
  }

  // Отобразить историю в списке
  function renderHistory() {
    if (history.length === 0) {
      historyList.innerHTML = '<li style="color:#999; cursor: default;">История пуста</li>';
      return;
    }
    historyList.innerHTML = history.map((item, i) =>
      `<li data-index="${i}">${item}</li>`).join('');
  }
  renderHistory();

  // Сохранить историю в localStorage
  function saveHistory() {
    localStorage.setItem(historyKey, JSON.stringify(history));
  }

  // Сохранить настройки ввода
  function saveSettings() {
    settings.amount = amountInput.value;
    settings.from = fromSelect.value;
    settings.to = toSelect.value;
    localStorage.setItem(settingsKey, JSON.stringify(settings));
  }

  // Восстановить настройки ввода
  function restoreSettings() {
    if (settings.amount) amountInput.value = settings.amount;
    if (settings.from) fromSelect.value = settings.from;
    if (settings.to) toSelect.value = settings.to;
  }
  restoreSettings();

  // Очистка истории
  clearHistoryBtn.addEventListener('click', () => {
    history = [];
    saveHistory();
    renderHistory();
  });

  // Клик по истории - подставляем в форму и считаем
  historyList.addEventListener('click', e => {
    if(e.target.tagName.toLowerCase() === 'li' && e.target.dataset.index !== undefined) {
      const i = +e.target.dataset.index;
      const entry = history[i];
      // Формат: "100 USD → KZT = 52000"
      const matches = entry.match(/^([\d.]+)\s+(\w+)\s+→\s+(\w+)/);
      if(matches) {
        amountInput.value = matches[1];
        fromSelect.value = matches[2];
        toSelect.value = matches[3];
        saveSettings();
        calculateAndShow();
      }
    }
  });

  // Переключатель видимости блока ручного ввода
  toggleBtn.addEventListener('click', () => {
    if(manualRateContent.style.display === 'block') {
      manualRateContent.style.display = 'none';
      manualRatePanel.style.height = '40px';
      toggleBtn.textContent = '▼';
    } else {
      manualRateContent.style.display = 'block';
      manualRatePanel.style.height = '110px';
      toggleBtn.textContent = '▲';
    }
  });

  // Обработка ввода вручную курса REF → KEY
  manualInput.addEventListener('input', () => {
    let val = parseFloat(manualInput.value);
    if(!isNaN(val) && val > 0) {
      keyToRef = val;
      localStorage.setItem(manualRateKey, keyToRef);
      // Если есть введённая сумма и валюта, пересчитаем
      if(amountInput.value && fromSelect.value && toSelect.value) {
        calculateAndShow();
      }
    }
  });

  // Проверка корректности введённых данных
  function validate() {
    let valid = true;

    if(!amountInput.value || isNaN(parseFloat(amountInput.value)) || parseFloat(amountInput.value) < 0) {
      amountInput.classList.add('error');
      valid = false;
    } else {
      amountInput.classList.remove('error');
    }

    if(!fromSelect.value) {
      fromSelect.classList.add('error');
      valid = false;
    } else {
      fromSelect.classList.remove('error');
    }

    if(!toSelect.value) {
      toSelect.classList.add('error');
      valid = false;
    } else {
      toSelect.classList.remove('error');
    }

    if(fromSelect.value === toSelect.value) {
      valid = false;
      statusDiv.textContent = "Валюты не должны совпадать";
      statusDiv.className = 'error';
    } else {
      statusDiv.textContent = '';
      statusDiv.className = '';
    }

    return valid;
  }

  // Конвертация валюты с учётом курсов KEY → USD и KEY → REF (ручной)
  // Алгоритм:
  // Все валюты конвертируем через KEY:
  // USD → KEY: amount / keyToUsd
  // REF → KEY: amount / keyToRef (ручной курс)
  // KZT → KEY: amount / kztToKey (kztToKey вычислим из курса USD/KZT)
  // KEY → USD: amount * keyToUsd
  // KEY → REF: amount * keyToRef
  // KEY → KZT: amount * kztToKey
  // Конечный результат вычисляется через KEY

  // Курсы USD и KZT относительно KEY — определяются через USD → KEY (1/keyToUsd) и KZT → KEY (по курсу из API)
  // Для USD и KZT возьмём обменный курс USD/KZT из API (или 1, если API недоступен)

  // Для упрощения в этой версии: считаем KZT → KEY через курс USD/KZT API
  let usdToKzt = null; // курс из API
  let kztToKey = null;

  // Получение курсов USD и KZT от API
  async function fetchUsdRates() {
    statusDiv.textContent = 'Загрузка курсов...';
    statusDiv.className = 'loading';

    try {
      const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=KZT');
      if(!res.ok) throw new Error('Ошибка API');
      const data = await res.json();

      usdToKzt = data.rates.KZT;
      kztToKey = usdToKzt ? 1 / (usdToKzt * keyToUsd) : null;

      statusDiv.textContent = 'Курсы обновлены';
      statusDiv.className = 'success';

    } catch (e) {
      statusDiv.textContent = 'Не удалось загрузить курсы, используется локальный курс';
      statusDiv.className = 'error';

      // Если API не работает, ставим курс KZT → KEY как примерно 1/(usdToKzt * keyToUsd)
      usdToKzt = 470; // примерный курс USD/KZT
      kztToKey = 1 / (usdToKzt * keyToUsd);
    }
  }

  // Вызов загрузки курсов сразу при загрузке
  fetchUsdRates();

  // Конвертация
  function convert(amount, from, to) {
    // Сначала приводим amount к KEY
    let amountInKey;

    switch(from) {
      case 'KEY':
        amountInKey = amount;
        break;
      case 'USD':
        amountInKey = amount / keyToUsd;
        break;
      case 'REF':
        amountInKey = amount / keyToRef;
        break;
      case 'KZT':
        if (kztToKey) {
          amountInKey = amount * kztToKey;
        } else {
          // Если курс KZT не известен, считаем 0 и выдаём ошибку
          throw new Error('Курс KZT неизвестен');
        }
        break;
      default:
        throw new Error('Неизвестная валюта отправления');
    }

    // Теперь из KEY в целевую валюту
    switch(to) {
      case 'KEY':
        return amountInKey;
      case 'USD':
        return amountInKey * keyToUsd;
      case 'REF':
        return amountInKey * keyToRef;
      case 'KZT':
        if(usdToKzt) {
          return amountInKey * keyToUsd * usdToKzt;
        } else {
          throw new Error('Курс KZT неизвестен');
        }
      default:
        throw new Error('Неизвестная валюта назначения');
    }
  }

  // Основная функция расчёта и отображения результата
  function calculateAndShow() {
    if(!validate()) {
      resultDiv.textContent = '–';
      return;
    }
    const amount = parseFloat(amountInput.value);
    const from = fromSelect.value;
    const to = toSelect.value;

    try {
      const converted = convert(amount, from, to);
      const rounded = Math.round(converted * 100) / 100;
      resultDiv.textContent = `${rounded} ${to}`;

      // Добавить в историю
      const entry = `${amount} ${from} → ${to} = ${rounded}`;
      if(history[0] !== entry) {
        history.unshift(entry);
        if(history.length > 15) history.pop();
        saveHistory();
        renderHistory();
      }
      statusDiv.textContent = '';
      statusDiv.className = '';
    } catch(err) {
      resultDiv.textContent = 'Ошибка';
      statusDiv.textContent = err.message;
      statusDiv.className = 'error';
    }
  }

  // События
  convertBtn.addEventListener('click', () => {
    saveSettings();
    calculateAndShow();
  });

  amountInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') {
      saveSettings();
      calculateAndShow();
    }
  });

  fromSelect.addEventListener('change', () => {
    saveSettings();
    calculateAndShow();
  });

  toSelect.addEventListener('change', () => {
    saveSettings();
    calculateAndShow();
  });

  // Авторасчёт при изменении данных
  amountInput.addEventListener('input', () => {
    saveSettings();
  });

</script>

</body>
</html>
