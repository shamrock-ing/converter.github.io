<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Конвертер KEY ↔ REF с графиком и UX улучшениями</title>
  <style>
    /* --- Общий стиль --- */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 900px;
      width: 100%;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .panel {
      flex: 1;
      min-width: 260px;
    }
    h1, h2 {
      margin: 0 0 16px;
      font-weight: 600;
      color: #2c3e50;
    }

    /* --- Формы и кнопки --- */
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      border-color: #3498db;
      outline: none;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    button:hover {
      background: #2980b9;
    }
    button.clear {
      background: #e74c3c;
    }
    button.clear:hover {
      background: #c0392b;
    }

    /* --- История --- */
    #history {
      max-height: 200px;
      overflow-y: auto;
      border-top: 1px solid #eee;
      padding-top: 8px;
      margin-top: 16px;
    }
    #history li {
      padding: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      border-bottom: 1px solid transparent;
      transition: background-color 0.2s, border-color 0.2s;
    }
    #history li:hover {
      background: #e8f5fc;
      border-color: #ddd;
    }

    /* --- Tooltips --- */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 180px;
      background-color: #2c3e50;
      color: #fff;
      text-align: left;
      border-radius: 4px;
      padding: 6px;
      position: absolute;
      top: -5px;
      left: 105%;
      z-index: 1;
      font-size: 0.85rem;
      line-height: 1.2em;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* --- Уведомления --- */
    #notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #2ecc71;
      color: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    #notification.show {
      opacity: 1;
    }

    /* --- Canvas графика --- */
    canvas {
      width: 100%;
      border-radius: 6px;
      background: #fafafa;
      border: 1px solid #ddd;
    }

    /* --- Адаптив --- */
    @media(max-width: 700px) {
      .container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>Конвертер валют</h1>

      <label for="amount">Сумма</label>
      <input id="amount" type="number" placeholder="Введите сумму" min="0" step="any" />

      <label for="from">Из:
        <span class="tooltip">ⓘ
          <span class="tooltiptext">
            KEY — внутриигровой ключ, REF — refined metal.
          </span>
        </span>
      </label>
      <select id="from">
        <option value="KEY">KEY</option>
        <option value="REF">REF</option>
      </select>

      <label for="to">В:
        <span class="tooltip">ⓘ
          <span class="tooltiptext">REF — refined metal, KEY — внутриигровой ключ.</span>
        </span>
      </label>
      <select id="to">
        <option value="REF">REF</option>
        <option value="KEY">KEY</option>
      </select>

      <button id="swapBtn">Поменять местами</button>

      <div id="history-header" style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
        <strong>История</strong>
        <button class="clear" id="clearHistory">Очистить</button>
      </div>
      <ul id="history"></ul>
    </div>

    <div class="panel">
      <h2>График курса KEY → REF</h2>
      <canvas id="chart" height="200"></canvas>
      <small>Обновление каждые 5 минут</small>
    </div>
  </div>

  <div id="notification"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  (async () => {
    const API_KEY = '68a1d6d01326fe092a02c00c';
    const HIST_KEY = 'bp_conv_history';
    const CHART_KEY = 'bp_price_history';

    const amountInput = document.getElementById('amount');
    const fromSelect = document.getElementById('from');
    const toSelect = document.getElementById('to');
    const swapBtn = document.getElementById('swapBtn');
    const historyEl = document.getElementById('history');
    const clearBtn = document.getElementById('clearHistory');
    const notifyEl = document.getElementById('notification');
    const chartCtx = document.getElementById('chart').getContext('2d');

    let history = JSON.parse(localStorage.getItem(HIST_KEY)) || [];
    let chartData = JSON.parse(localStorage.getItem(CHART_KEY)) || { labels: [], data: [] };
    let keyToRefRate = null;

    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        labels: chartData.labels.map(ts => new Date(ts)),
        datasets: [{
          label: '1 KEY → REF',
          data: chartData.data,
          borderColor: '#e74c3c',
          backgroundColor: 'rgba(231,76,60,0.2)',
          fill: true,
          tension: 0.2
        }]
      },
      options: {
        scales: {
          x: { type: 'time', time: { unit: 'minute' }, title: { display: true, text: 'Время' } },
          y: { beginAtZero: false, title: { display: true, text: 'Курс' } }
        },
        interaction: { mode: 'nearest', intersect: false },
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => ctx.parsed.y.toFixed(4)
            }
          }
        }
      }
    });

    function showNotification(msg, isError = false) {
      notifyEl.textContent = msg;
      notifyEl.style.background = isError ? '#e74c3c' : '#2ecc71';
      notifyEl.classList.add('show');
      setTimeout(() => notifyEl.classList.remove('show'), 3000);
    }

    function saveHistory() {
      localStorage.setItem(HIST_KEY, JSON.stringify(history));
    }
    function renderHistory() {
      historyEl.innerHTML = '';
      history.forEach(h => {
        const li = document.createElement('li');
        li.textContent = `${h.fromVal} ${h.fromCur} → ${h.toVal} ${h.toCur} (${new Date(h.time).toLocaleTimeString()})`;
        li.onclick = () => {
          amountInput.value = h.fromVal;
          fromSelect.value = h.fromCur;
          toSelect.value = h.toCur;
          calculate();
        };
        historyEl.appendChild(li);
      });
    }

    function saveChartPoint(rate) {
      const ts = Date.now();
      chartData.labels.push(ts);
      chartData.data.push(rate);
      if (chartData.labels.length > 60) {
        chartData.labels.shift();
        chartData.data.shift();
      }
      localStorage.setItem(CHART_KEY, JSON.stringify(chartData));
      chart.data.labels = chartData.labels.map(t => new Date(t));
      chart.data.datasets[0].data = chartData.data;
      chart.update();
    }

    async function updateRate() {
      try {
        const url = `https://backpack.tf/api/IGetPriceHistory/v1?appid=440&item=${encodeURIComponent('Mann Co. Supply Crate Key')}&quality=Unique&tradable=Tradable&craftable=Craftable&priceindex=0&key=${API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Сеть API не отвечает');
        const json = await res.json();
        const prices = json.response?.prices;
        if (!prices?.length) throw new Error('Данные не найдены');
        keyToRefRate = prices[prices.length - 1].value;
        saveChartPoint(keyToRefRate);
        showNotification(`Курс обновлён: 1 KEY = ${keyToRefRate.toFixed(4)} REF`);
      } catch (e) {
        console.error(e);
        showNotification('Ошибка загрузки курса', true);
      }
    }

    function calculate() {
      if (!keyToRefRate) return;
      const amt = parseFloat(amountInput.value);
      if (isNaN(amt) || amt <= 0) return;
      if (fromSelect.value === toSelect.value) {
        showNotification('Нельзя конвертировать валюту в саму себя', true);
        return;
      }
      let res = fromSelect.value === 'KEY'
        ? amt * keyToRefRate
        : amt / keyToRefRate;

      history.unshift({
        fromVal: amt.toFixed(4),
        fromCur: fromSelect.value,
        toVal: res.toFixed(4),
        toCur: toSelect.value,
        time: Date.now()
      });
      if (history.length > 20) history.pop();
      saveHistory();
      renderHistory();
      showNotification(`Результат: ${res.toFixed(4)} ${toSelect.value}`);
      amountInput.value = '';
    }

    swapBtn.onclick = () => {
      [fromSelect.value, toSelect.value] = [toSelect.value, fromSelect.value];
      calculate();
    };
    document.getElementById('clearHistory').onclick = () => {
      if (confirm('Очистить историю?')) {
        history = [];
        saveHistory();
        renderHistory();
        showNotification('История очищена');
      }
    };
    amountInput.addEventListener('input', debounce(calculate, 300));
    fromSelect.addEventListener('change', calculate);
    toSelect.addEventListener('change', calculate);

    await updateRate();
    renderHistory();
    setInterval(updateRate, 5 * 60 * 1000);
  })();
  function debounce(fn, delay) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }
  </script>
</body>
</html>
