<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Конвертер валют с историей и графиком</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f7f9fc;
    color: #222;
    margin: 20px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }
  h1 {
    text-align: center;
    margin-bottom: 0.5em;
  }
  .converter {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 2em;
  }
  .box {
    background: white;
    border-radius: 8px;
    padding: 15px 20px;
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.1);
    min-width: 250px;
    flex-grow: 1;
  }
  label {
    display: block;
    margin-bottom: 0.25em;
    font-weight: 600;
  }
  input[type=number] {
    width: 100%;
    padding: 8px 10px;
    font-size: 1.1em;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-sizing: border-box;
    transition: border-color 0.3s;
  }
  input[type=number]:focus {
    border-color: #3f51b5;
    outline: none;
  }
  select {
    width: 100%;
    padding: 8px 10px;
    margin-top: 5px;
    font-size: 1em;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    margin-top: 12px;
    padding: 8px 14px;
    background: #3f51b5;
    color: white;
    border: none;
    border-radius: 5px;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s;
  }
  button:hover {
    background: #2c3b9b;
  }
  #history {
    max-height: 240px;
    overflow-y: auto;
  }
  #history li {
    cursor: pointer;
    padding: 6px 8px;
    border-bottom: 1px solid #eee;
    font-size: 0.9em;
    color: #555;
  }
  #history li:hover {
    background-color: #e6e9fc;
  }
  #history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
  }
  #notification {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #3f51b5;
    color: white;
    padding: 12px 20px;
    border-radius: 5px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
  }
  #notification.show {
    opacity: 1;
    pointer-events: auto;
  }
  canvas {
    max-width: 100%;
  }
</style>
</head>
<body>
<h1>Конвертер валют KEY ↔ REF</h1>
<div class="converter">
  <div class="box">
    <label for="amountFrom">Сумма</label>
    <input type="number" id="amountFrom" min="0" step="0.0001" placeholder="Введите сумму" />
    <label for="currencyFrom">Валюта</label>
    <select id="currencyFrom">
      <option value="key">KEY</option>
      <option value="ref">REF</option>
      <option value="usd">USD</option>
      <option value="kzt">KZT</option>
    </select>
  </div>
  <div class="box">
    <label for="amountTo">Результат</label>
    <input type="number" id="amountTo" min="0" step="0.0001" placeholder="Рассчитано" />
    <label for="currencyTo">Валюта</label>
    <select id="currencyTo">
      <option value="ref">REF</option>
      <option value="key">KEY</option>
      <option value="usd">USD</option>
      <option value="kzt">KZT</option>
    </select>
  </div>
</div>
<button id="swapBtn">Поменять местами</button>

<div id="history-section" style="margin-top:30px;">
  <div id="history-header">
    <h2>История конвертаций</h2>
    <button id="clearHistoryBtn" style="background:#d32f2f;">Очистить историю</button>
  </div>
  <ul id="history"></ul>
</div>

<canvas id="chart" height="180"></canvas>

<div id="notification"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  const amountFrom = document.getElementById('amountFrom');
  const currencyFrom = document.getElementById('currencyFrom');
  const amountTo = document.getElementById('amountTo');
  const currencyTo = document.getElementById('currencyTo');
  const swapBtn = document.getElementById('swapBtn');
  const historyList = document.getElementById('history');
  const clearHistoryBtn = document.getElementById('clearHistoryBtn');
  const notification = document.getElementById('notification');
  const chartCtx = document.getElementById('chart').getContext('2d');

  // Курсы валют (пример начальных)
  let rates = {
    usd: 1, 
    kzt: 470, 
    key: 0, // в ref
    ref: 1,
  };

  // Хранение истории
  let history = JSON.parse(localStorage.getItem('history')) || [];

  // Данные графика (KEY → REF)
  let chartData = {
    labels: [],
    datasets: [{
      label: 'Курс KEY → REF',
      data: [],
      borderColor: '#3f51b5',
      backgroundColor: 'rgba(63,81,181,0.2)',
      fill: true,
      tension: 0.2,
      pointRadius: 3,
      pointHoverRadius: 6,
    }]
  };

  // Создаем график
  const chart = new Chart(chartCtx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      interaction: {
        mode: 'nearest',
        intersect: false
      },
      plugins: {
        tooltip: {
          enabled: true,
          mode: 'nearest',
          intersect: false,
          callbacks: {
            label: ctx => ctx.parsed.y.toFixed(4)
          }
        },
        zoom: {
          zoom: {
            wheel: {
              enabled: true
            },
            pinch: {
              enabled: true
            },
            mode: 'x',
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'minute',
            tooltipFormat: 'HH:mm:ss',
          },
          title: {
            display: true,
            text: 'Время'
          }
        },
        y: {
          beginAtZero: false,
          title: {
            display: true,
            text: 'Курс'
          }
        }
      }
    },
    plugins: [Chart.Zoom], // не забудь подключить Chart.Zoom плагин отдельно
  });

  // Показывать уведомления
  function showNotification(text) {
    notification.textContent = text;
    notification.classList.add('show');
    setTimeout(() => {
      notification.classList.remove('show');
    }, 4000);
  }

  // Дебаунс (задержка вызова функции)
  function debounce(fn, delay) {
    let timer;
    return function(...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  // Загрузка курсов floatrates (usd, kzt)
  async function loadFloatRates() {
    try {
      const res = await fetch('https://www.floatrates.com/daily/usd.json');
      if (!res.ok) throw new Error('Ошибка сети floatrates');
      const data = await res.json();
      if(!data.kzt || !data.kzt.rate) throw new Error('Нет данных KZT floatrates');

      rates.usd = 1;
      rates.kzt = data.kzt.rate;
    } catch(e) {
      showNotification(`Ошибка загрузки курсов floatrates: ${e.message}`);
      console.error(e);
    }
  }

  // Загрузка цен с backpack.tf (key и ref)
  async function loadBackpackTfPrices() {
    try {
      // Пример API ключа и запроса (замени на настоящий URL с API)
      const apiKey = '68a1d6d01326fe092a02c00c';
      const res = await fetch(`https://backpack.tf/api/IGetMarketPrices/v1/?key=${apiKey}`);
      if (!res.ok) throw new Error('Ошибка сети backpack.tf');
      const json = await res.json();
      // Предполагаемая структура (пример, нужно проверить документацию!)
      // Здесь для демонстрации: 
      // key в refined metal (ref), ref = 1
      const keyPriceRef = json.response?.items?.['Mann Co. Supply Crate Key']?.prices?.['Refined Metal']?.value || 2.4;
      rates.key = keyPriceRef;

      // REF фиксированно 1 (если нужно менять, делай)
      rates.ref = 1;
    } catch(e) {
      showNotification(`Ошибка загрузки backpack.tf: ${e.message}`);
      console.error(e);
    }
  }

  // Конвертация валют
  function convertCurrency(amount, fromCur, toCur) {
    if (fromCur === toCur) return amount;
    let amountInRef;

    if(fromCur === 'usd') amountInRef = amount * rates.kzt / rates.kzt; // usd в ref пока нет прямого курса, можно улучшить
    else if(fromCur === 'kzt') amountInRef = amount / rates.kzt;
    else if(fromCur === 'key') amountInRef = amount * rates.key;
    else if(fromCur === 'ref') amountInRef = amount;

    let result;
    if(toCur === 'usd') {
      result = amountInRef; // Для примера упрощено
    } else if(toCur === 'kzt') {
      result = amountInRef * rates.kzt;
    } else if(toCur === 'key') {
      result = amountInRef / rates.key;
    } else if(toCur === 'ref') {
      result = amountInRef;
    } else {
      result = amount;
    }
    return result;
  }

  // Основная функция конвертации с проверками и обновлением истории
  function convert(direction) {
    if(direction === 'forward') {
      let fromVal = parseFloat(amountFrom.value);
      if (isNaN(fromVal) || fromVal <= 0) {
        amountTo.value = '';
        return;
      }
      const toVal = convertCurrency(fromVal, currencyFrom.value, currencyTo.value);
      amountTo.value = toVal.toFixed(4);

      saveHistory(fromVal, currencyFrom.value, toVal, currencyTo.value);
    } else {
      let toVal = parseFloat(amountTo.value);
      if (isNaN(toVal) || toVal <= 0) {
        amountFrom.value = '';
        return;
      }
      const fromVal = convertCurrency(toVal, currencyTo.value, currencyFrom.value);
      amountFrom.value = fromVal.toFixed(4);

      saveHistory(fromVal, currencyFrom.value, toVal, currencyTo.value);
    }
  }

  // История и сохранение
  function saveHistory(fromAmount, fromCur, toAmount, toCur) {
    const entry = {
      fromAmount: fromAmount.toFixed(4),
      fromCur,
      toAmount: toAmount.toFixed(4),
      toCur,
      time: new Date().toISOString()
    };
    history.unshift(entry);
    if(history.length > 20) history.pop();
    localStorage.setItem('history', JSON.stringify(history));
    renderHistory();
  }

  function renderHistory() {
    historyList.innerHTML = '';
    history.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.fromAmount} ${item.fromCur.toUpperCase()} → ${item.toAmount} ${item.toCur.toUpperCase()} (${new Date(item.time).toLocaleTimeString()})`;
      li.title = 'Клик для использования';
      li.onclick = () => {
        amountFrom.value = item.fromAmount;
        currencyFrom.value = item.fromCur;
        amountTo.value = item.toAmount;
        currencyTo.value = item.toCur;
      };
      historyList.appendChild(li);
    });
  }

  clearHistoryBtn.onclick = () => {
    if(confirm('Очистить всю историю?')) {
      history = [];
      localStorage.removeItem('history');
      renderHistory();
      showNotification('История очищена');
    }
  };

  // Swap currencies and values
  swapBtn.onclick = () => {
    const tempCur = currencyFrom.value;
    currencyFrom.value = currencyTo.value;
    currencyTo.value = tempCur;

    const tempAmt = amountFrom.value;
    amountFrom.value = amountTo.value;
    amountTo.value = tempAmt;
  };

  // Форматирование ввода и конвертация с задержкой
  amountFrom.addEventListener('input', debounce(() => {
    convert('forward');
  }, 300));

  amountTo.addEventListener('input', debounce(() => {
    convert('backward');
  }, 300));

  currencyFrom.addEventListener('change', () => convert('forward'));
  currencyTo.addEventListener('change', () => convert('forward'));

  // Обновление данных и графика каждые 5 минут
  async function updateAll() {
    try {
      await loadFloatRates();
      await loadBackpackTfPrices();
      convert('forward');
      updateChart();
      showNotification('Курсы успешно обновлены');
    } catch(e) {
      showNotification('Ошибка обновления курсов');
      console.error(e);
    }
  }

  // Обновление графика
  function updateChart() {
    const now = new Date();
    const lastPrice = rates.key / rates.ref; // key to ref
    chartData.labels.push(now);
    chartData.datasets[0].data.push(lastPrice);

    // Ограничим максимум точек
    if(chartData.labels.length > 50) {
      chartData.labels.shift();
      chartData.datasets[0].data.shift();
    }
    chart.update();
  }

  // Инициализация
  (async () => {
    renderHistory();
    await updateAll();

    // Интервал обновления
    setInterval(async () => {
      await updateAll();
    }, 5 * 60 * 1000); // 5 минут
  })();

})();
</script>

</body>
</html>
