<script>
  const keyToUsd = 2.4;
  const keyToRef = 52.22;
  let usdRates = null;
  const historyKey = 'converter_history';
  const settingsKey = 'converter_settings';
  const ratesKey = 'usd_rates';

  let history = JSON.parse(localStorage.getItem(historyKey)) || [];
  let settings = JSON.parse(localStorage.getItem(settingsKey)) || {};

  const amountInput = document.getElementById('amount');
  const fromSelect = document.getElementById('from');
  const toSelect = document.getElementById('to');
  const resultDiv = document.getElementById('result');
  const historyList = document.getElementById('historyList');
  const convertBtn = document.getElementById('convertBtn');

  function renderHistory() {
    historyList.innerHTML = history.map((item, i) =>
      `<li data-index="${i}">${item}</li>`).join('');
  }
  renderHistory();

  function saveHistory() {
    localStorage.setItem(historyKey, JSON.stringify(history));
  }

  function saveSettings() {
    settings.amount = amountInput.value;
    settings.from = fromSelect.value;
    settings.to = toSelect.value;
    localStorage.setItem(settingsKey, JSON.stringify(settings));
  }

  function restoreSettings() {
    if (settings.amount) amountInput.value = settings.amount;
    if (settings.from) fromSelect.value = settings.from;
    if (settings.to) toSelect.value = settings.to;
  }
  restoreSettings();

  function validateAmount() {
    const val = parseFloat(amountInput.value);
    if (!val || val <= 0) {
      amountInput.classList.add('error');
      showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –±–æ–ª—å—à–µ 0');
      return false;
    }
    amountInput.classList.remove('error');
    showError('');
    return true;
  }

  let errorTimeout;
  function showError(msg) {
    let errorEl = document.querySelector('.error-message');
    if (!errorEl) {
      errorEl = document.createElement('div');
      errorEl.className = 'error-message';
      amountInput.after(errorEl);
    }
    if (msg) {
      errorEl.textContent = msg;
      errorEl.classList.add('visible');
      clearTimeout(errorTimeout);
      errorTimeout = setTimeout(() => {
        errorEl.classList.remove('visible');
      }, 4000);
    } else {
      errorEl.classList.remove('visible');
      errorEl.textContent = '';
    }
  }

  async function loadFloatRates() {
    convertBtn.disabled = true;
    try {
      const res = await fetch('https://www.floatrates.com/daily/usd.json');
      usdRates = await res.json();
      localStorage.setItem(ratesKey, JSON.stringify(usdRates));
      convertBtn.disabled = false;
      convertCurrency(); // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    } catch {
      const cached = localStorage.getItem(ratesKey);
      if (cached) {
        usdRates = JSON.parse(cached);
        resultDiv.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã.';
        convertBtn.disabled = false;
        convertCurrency(); // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      } else {
        resultDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤.';
      }
    }
  }

  function convertCurrency() {
    if (!validateAmount()) {
      resultDiv.textContent = '‚Äì';
      return;
    }
    if (!usdRates) {
      resultDiv.textContent = '–ö—É—Ä—Å—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.';
      return;
    }

    const amt = parseFloat(amountInput.value);
    const from = fromSelect.value;
    const to = toSelect.value;

    if (from === to) {
      resultDiv.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–Ω—ã–µ –≤–∞–ª—é—Ç—ã.';
      return;
    }

    let inUsd;
    switch(from) {
      case 'USD': inUsd = amt; break;
      case 'KZT': inUsd = amt / usdRates['kzt'].rate; break;
      case 'KEY': inUsd = amt * keyToUsd; break;
      case 'REF': inUsd = amt / keyToRef * keyToUsd; break;
      default: inUsd = 0;
    }

    let result;
    switch(to) {
      case 'USD': result = inUsd; break;
      case 'KZT': result = inUsd * usdRates['kzt'].rate; break;
      case 'KEY': result = inUsd / keyToUsd; break;
      case 'REF': result = inUsd / keyToUsd * keyToRef; break;
      default: result = 0;
    }

    const resultStr = `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${result.toFixed(2)} ${to}`;
    resultDiv.textContent = resultStr;

    const historyItem = `${amt} ${from} ‚Üí ${result.toFixed(2)} ${to}`;
    if (!history.includes(historyItem)) {
      history.unshift(historyItem);
      if (history.length > 10) history.pop();
      saveHistory();
      renderHistory();
    }

    saveSettings();
  }

  // üîÅ –ê–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–µ–ª–µ–∫—Ç–æ–≤
  amountInput.addEventListener('input', () => {
    validateAmount();
    convertCurrency();
  });
  fromSelect.addEventListener('change', () => {
    convertCurrency();
    saveSettings();
  });
  toSelect.addEventListener('change', () => {
    convertCurrency();
    saveSettings();
  });

  convertBtn.addEventListener('click', convertCurrency);

  historyList.addEventListener('click', e => {
    if (e.target.tagName !== 'LI') return;
    const text = e.target.textContent;
    const match = text.match(/^([\d.]+) (\w+) ‚Üí ([\d.]+) (\w+)$/);
    if (match) {
      amountInput.value = match[1];
      fromSelect.value = match[2];
      toSelect.value = match[4];
      resultDiv.textContent = text.split('‚Üí')[1].trim();
      saveSettings();
      convertCurrency(); // –ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
    }
  });

  loadFloatRates(); // –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
</script>
