<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Конвертер валют</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 40px 20px;
    background: #f7f9fc;
    font-family: 'Inter', sans-serif;
    color: #222;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .container {
    background: #fff;
    padding: 30px 40px 40px;
    border-radius: 14px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    max-width: 480px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    font-weight: 600;
    font-size: 2.2rem;
    margin-bottom: 30px;
    color: #1a1a1a;
    user-select: none;
  }
  label {
    align-self: flex-start;
    margin-bottom: 6px;
    font-weight: 600;
    color: #444;
    user-select: none;
  }
  .row {
    display: flex;
    width: 100%;
    gap: 12px;
    margin-bottom: 18px;
  }
  .col {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  input, select {
    width: 100%;
    padding: 14px 16px;
    border: 1.8px solid #cbd5e1;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 400;
    color: #1f2937;
    background: #fefefe;
    transition:
      border-color 0.3s ease,
      box-shadow 0.3s ease;
  }
  input::placeholder {
    color: #94a3b8;
  }
  input:focus, select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 8px #3b82f6aa;
    background: #fff;
  }
  input.error, select.error {
    border-color: #ef4444;
    box-shadow: 0 0 8px #ef4444aa;
    background: #ffe6e6;
  }
  .error-message {
    color: #ef4444;
    font-size: 0.85rem;
    margin-top: -14px;
    margin-bottom: 10px;
    align-self: flex-start;
    user-select: none;
    height: 18px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .error-message.visible {
    opacity: 1;
  }
  button {
    width: 100%;
    padding: 15px 0;
    border: none;
    border-radius: 12px;
    background-color: #3b82f6;
    color: #fff;
    font-weight: 600;
    font-size: 1.15rem;
    cursor: pointer;
    transition:
      background-color 0.3s ease,
      transform 0.2s ease;
    user-select: none;
  }
  button:hover {
    background-color: #2563eb;
    transform: scale(1.05);
  }
  button:active {
    transform: scale(0.98);
  }
  #history {
    margin-top: 28px;
    width: 100%;
  }
  #history h3 {
    margin-bottom: 12px;
    font-weight: 600;
    font-size: 1rem;
    color: #475569;
    user-select: none;
  }
  #history ul {
    max-height: 130px;
    overflow-y: auto;
    padding-left: 18px;
    margin: 0;
    font-size: 0.95rem;
    color: #64748b;
  }
  #history li {
    margin-bottom: 7px;
    cursor: pointer;
    transition: color 0.2s ease;
  }
  #history li:hover {
    color: #3b82f6;
    text-decoration: underline;
  }
</style>
</head>
<body>

  <div class="container">
    <h1>Конвертер валют</h1>

    <div class="row">
      <div class="col">
        <label for="amountFrom">Сумма (От)</label>
        <input type="number" id="amountFrom" placeholder="Введите сумму" min="0" step="any" autocomplete="off" />
        <div class="error-message" id="errorFrom"></div>
      </div>
      <div class="col">
        <label for="currencyFrom">Валюта (От)</label>
        <select id="currencyFrom">
          <option value="USD">USD</option>
          <option value="KZT">KZT</option>
          <option value="KEY">KEY</option>
          <option value="REF">REF</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="amountTo">Сумма (К)</label>
        <input type="number" id="amountTo" placeholder="Результат" min="0" step="any" autocomplete="off" />
        <div class="error-message" id="errorTo"></div>
      </div>
      <div class="col">
        <label for="currencyTo">Валюта (К)</label>
        <select id="currencyTo">
          <option value="USD">USD</option>
          <option value="KZT">KZT</option>
          <option value="KEY">KEY</option>
          <option value="REF">REF</option>
        </select>
      </div>
    </div>

    <button id="swapBtn" title="Поменять валюты местами">⇄ Поменять валюты</button>

    <div id="history">
      <h3>История конвертаций:</h3>
      <ul id="historyList"></ul>
    </div>
  </div>

<script>
  const keyToUsd = 2.4;
  const keyToRef = 52.22;
  const historyKey = 'converter_history_v2';
  const settingsKey = 'converter_settings_v2';

  let usdRates = null;
  let updating = false; // Флаг обновления курсов

  // Элементы
  const amountFrom = document.getElementById('amountFrom');
  const amountTo = document.getElementById('amountTo');
  const currencyFrom = document.getElementById('currencyFrom');
  const currencyTo = document.getElementById('currencyTo');
  const errorFrom = document.getElementById('errorFrom');
  const errorTo = document.getElementById('errorTo');
  const historyList = document.getElementById('historyList');
  const swapBtn = document.getElementById('swapBtn');

  // История и настройки из localStorage
  let history = JSON.parse(localStorage.getItem(historyKey)) || [];
  let settings = JSON.parse(localStorage.getItem(settingsKey)) || {};

  // Отрисовка истории
  function renderHistory() {
    historyList.innerHTML = history.map((item,i) =>
      `<li data-index="${i}">${item}</li>`).join('');
  }

  // Сохраняем историю
  function saveHistory() {
    localStorage.setItem(historyKey, JSON.stringify(history));
  }
  // Сохраняем настройки
  function saveSettings() {
    settings.amountFrom = amountFrom.value;
    settings.amountTo = amountTo.value;
    settings.currencyFrom = currencyFrom.value;
    settings.currencyTo = currencyTo.value;
    localStorage.setItem(settingsKey, JSON.stringify(settings));
  }
  // Восстанавливаем настройки
  function restoreSettings() {
    if (settings.amountFrom !== undefined) amountFrom.value = settings.amountFrom;
    if (settings.amountTo !== undefined) amountTo.value = settings.amountTo;
    if (settings.currencyFrom) currencyFrom.value = settings.currencyFrom;
    if (settings.currencyTo) currencyTo.value = settings.currencyTo;
  }

  // Валидация суммы
  function validateAmount(inputEl, errorEl) {
    const val = parseFloat(inputEl.value);
    if (isNaN(val) || val <= 0) {
      inputEl.classList.add('error');
      errorEl.textContent = 'Введите сумму больше 0';
      errorEl.classList.add('visible');
      return false;
    }
    inputEl.classList.remove('error');
    errorEl.textContent = '';
    errorEl.classList.remove('visible');
    return true;
  }

  // Загрузка курсов с floatrates (USD базис)
  async function loadFloatRates() {
    try {
      const res = await fetch('https://www.floatrates.com/daily/usd.json');
      usdRates = await res.json();
      //console.log('Курсы обновлены', usdRates);
    } catch {
      alert('Ошибка загрузки курсов валют.');
    }
  }

  // Конвертация валюты: fromAmount → toAmount
  // direction: 'forward' — из amountFrom, 'backward' — из amountTo
  function convert(direction) {
    if (!usdRates) return;

    let fromVal, toVal;
    if(direction === 'forward') {
      if (!validateAmount(amountFrom, errorFrom)) {
        amountTo.value = '';
        return;
      }
      fromVal = parseFloat(amountFrom.value);
    } else {
      if (!validateAmount(amountTo, errorTo)) {
        amountFrom.value = '';
        return;
      }
      toVal = parseFloat(amountTo.value);
    }

    const fromCur = currencyFrom.value;
    const toCur = currencyTo.value;

    // Преобразуем в USD
    function toUsd(amount, cur) {
      switch(cur) {
        case 'USD': return amount;
        case 'KZT': return amount / usdRates['kzt'].rate;
        case 'KEY': return amount * keyToUsd;
        case 'REF': return amount / keyToRef * keyToUsd;
        default: return 0;
      }
    }
    // USD → целевая валюта
    function fromUsd(amount, cur) {
      switch(cur) {
        case 'USD': return amount;
        case 'KZT': return amount * usdRates['kzt'].rate;
        case 'KEY': return amount / keyToUsd;
        case 'REF': return amount / keyToUsd * keyToRef;
        default: return 0;
      }
    }

    if(direction === 'forward') {
      const usdAmount = toUsd(fromVal, fromCur);
      const res = fromUsd(usdAmount, toCur);
      amountTo.value = res.toFixed(4);
      errorTo.textContent = '';
      amountTo.classList.remove('error');
    } else {
      const usdAmount = toUsd(toVal, toCur);
      const res = fromUsd(usdAmount, fromCur);
      amountFrom.value = res.toFixed(4);
      errorFrom.textContent = '';
      amountFrom.classList.remove('error');
    }

    // Обновляем историю
    const histStr = `${amountFrom.value} ${fromCur} → ${amountTo.value} ${toCur}`;
    if (!history.includes(histStr)) {
      history.unshift(histStr);
      if (history.length > 10) history.pop();
      saveHistory();
      renderHistory();
    }

    saveSettings();
  }

  // Обработчики ввода с задержкой debounce, чтобы не слишком часто считать
  function debounce(fn, delay) {
    let timer;
    return function(...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    }
  }

  // Флаги, чтобы избежать циклов пересчётов
  let fromTyping = false;
  let toTyping = false;

  // События
  amountFrom.addEventListener('input', () => {
    fromTyping = true;
    if (toTyping) return;
    convertDebounced('forward');
    fromTyping = false;
  });
  amountTo.addEventListener('input', () => {
    toTyping = true;
    if (fromTyping) return;
    convertDebounced('backward');
    toTyping = false;
  });
  currencyFrom.addEventListener('change', () => {
    convert('forward');
  });
  currencyTo.addEventListener('change', () => {
    convert('forward');
  });
  swapBtn.addEventListener('click', () => {
    // Поменять валюты местами и суммы (чтобы сохранить логику)
    const tmpCur = currencyFrom.value;
    currencyFrom.value = currencyTo.value;
    currencyTo.value = tmpCur;

    const tmpAmt = amountFrom.value;
    amountFrom.value = amountTo.value;
    amountTo.value = tmpAmt;

    convert('forward');
  });

  const convertDebounced = debounce(convert, 300);

  // Клик по истории - заполнить форму
  historyList.addEventListener('click', e => {
    if (e.target.tagName !== 'LI') return;
    const idx = +e.target.dataset.index;
    if (idx >= 0 && idx < history.length) {
      const parts = history[idx].split(' ');
      if(parts.length >= 4) {
        amountFrom.value = parts[0];
        currencyFrom.value = parts[1];
        amountTo.value = parts[3];
        currencyTo.value = parts[4];
        convert('forward');
      }
    }
  });

  // Загрузка курсов и начальный запуск
  async function init() {
    await loadFloatRates();
    restoreSettings();
    if(amountFrom.value) {
      convert('forward');
    } else if(amountTo.value) {
      convert('backward');
    }
    renderHistory();
    // Обновление курсов каждые 10 минут (600000 мс)
    setInterval(async () => {
      if (!updating) {
        updating = true;
        await loadFloatRates();
        updating = false;
        // Пересчёт после обновления курсов
        if(amountFrom.value) convert('forward');
      }
    }, 600000);
  }
  init();

</script>
</body>
</html>
